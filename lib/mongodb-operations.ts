// Stub exports for mongodb-operations (do not use on client)
export const getProducts = () => { throw new Error("Server-only: getProducts is not available on client."); };
export const createProduct = () => { throw new Error("Server-only: createProduct is not available on client."); };
export const updateProduct = () => { throw new Error("Server-only: updateProduct is not available on client."); };
export const deleteProduct = () => { throw new Error("Server-only: deleteProduct is not available on client."); };
export const getVendors = () => { throw new Error("Server-only: getVendors is not available on client."); };
export const getOrders = () => { throw new Error("Server-only: getOrders is not available on client."); };
export const getUserCart = () => { throw new Error("Server-only: getUserCart is not available on client."); };
export const updateUserProfileInDb = () => { throw new Error("Server-only: updateUserProfileInDb is not available on client."); };
export const deleteStore = () => { throw new Error("Server-only: deleteStore is not available on client."); };
export const deleteProductsByVendor = () => { throw new Error("Server-only: deleteProductsByVendor is not available on client."); };
export const deleteServicesByVendor = () => { throw new Error("Server-only: deleteServicesByVendor is not available on client."); };
export const deleteOrdersByVendor = () => { throw new Error("Server-only: deleteOrdersByVendor is not available on client."); };
export const deleteBookingsByVendor = () => { throw new Error("Server-only: deleteBookingsByVendor is not available on client."); };
export const deleteUserCartItemsByVendor = () => { throw new Error("Server-only: deleteUserCartItemsByVendor is not available on client."); };
export const deleteConversationsByVendor = () => { throw new Error("Server-only: deleteConversationsByVendor is not available on client."); };
export const deleteUser = () => { throw new Error("Server-only: deleteUser is not available on client."); };
export const deleteSessions = () => { throw new Error("Server-only: deleteSessions is not available on client."); };
export const getOrders = () => { throw new Error("Server-only: getOrders is not available on client."); };
export const getUserCart = () => { throw new Error("Server-only: getUserCart is not available on client."); };
export const updateUserProfileInDb = () => { throw new Error("Server-only: updateUserProfileInDb is not available on client."); };
export const deleteStore = () => { throw new Error("Server-only: deleteStore is not available on client."); };
export const deleteProductsByVendor = () => { throw new Error("Server-only: deleteProductsByVendor is not available on client."); };
export const deleteServicesByVendor = () => { throw new Error("Server-only: deleteServicesByVendor is not available on client."); };
export const deleteOrdersByVendor = () => { throw new Error("Server-only: deleteOrdersByVendor is not available on client."); };
export const deleteBookingsByVendor = () => { throw new Error("Server-only: deleteBookingsByVendor is not available on client."); };
export const deleteUserCartItemsByVendor = () => { throw new Error("Server-only: deleteUserCartItemsByVendor is not available on client."); };
export const deleteConversationsByVendor = () => { throw new Error("Server-only: deleteConversationsByVendor is not available on client."); };
export const deleteUser = () => { throw new Error("Server-only: deleteUser is not available on client."); };
export const deleteSessions = () => { throw new Error("Server-only: deleteSessions is not available on client."); };
// Stub exports for mongodb-operations (do not use on client)
export const getProducts = () => { throw new Error("Server-only: getProducts is not available on client."); };
export const createProduct = () => { throw new Error("Server-only: createProduct is not available on client."); };
export const updateProduct = () => { throw new Error("Server-only: updateProduct is not available on client."); };
export const deleteProduct = () => { throw new Error("Server-only: deleteProduct is not available on client."); };
export const getVendors = () => { throw new Error("Server-only: getVendors is not available on client."); };
export const getOrders = () => { throw new Error("Server-only: getOrders is not available on client."); };
export const getUserCart = () => { throw new Error("Server-only: getUserCart is not available on client."); };
export const updateUserProfileInDb = () => { throw new Error("Server-only: updateUserProfileInDb is not available on client."); };
export const deleteStore = () => { throw new Error("Server-only: deleteStore is not available on client."); };
export const deleteProductsByVendor = () => { throw new Error("Server-only: deleteProductsByVendor is not available on client."); };
export const deleteServicesByVendor = () => { throw new Error("Server-only: deleteServicesByVendor is not available on client."); };
export const deleteOrdersByVendor = () => { throw new Error("Server-only: deleteOrdersByVendor is not available on client."); };
export const deleteBookingsByVendor = () => { throw new Error("Server-only: deleteBookingsByVendor is not available on client."); };
export const deleteUserCartItemsByVendor = () => { throw new Error("Server-only: deleteUserCartItemsByVendor is not available on client."); };
export const deleteConversationsByVendor = () => { throw new Error("Server-only: deleteConversationsByVendor is not available on client."); };
export const deleteUser = () => { throw new Error("Server-only: deleteUser is not available on client."); };
export const deleteSessions = () => { throw new Error("Server-only: deleteSessions is not available on client."); };
// Stub exports for mongodb-operations (do not use on client)
export const getProducts = () => { throw new Error("Server-only: getProducts is not available on client."); };
export const createProduct = () => { throw new Error("Server-only: createProduct is not available on client."); };
export const updateProduct = () => { throw new Error("Server-only: updateProduct is not available on client."); };
export const deleteProduct = () => { throw new Error("Server-only: deleteProduct is not available on client."); };
export const getVendors = () => { throw new Error("Server-only: getVendors is not available on client."); };
export const getOrders = () => { throw new Error("Server-only: getOrders is not available on client."); };
export const getUserCart = () => { throw new Error("Server-only: getUserCart is not available on client."); };
export const updateUserProfileInDb = () => { throw new Error("Server-only: updateUserProfileInDb is not available on client."); };
export const deleteStore = () => { throw new Error("Server-only: deleteStore is not available on client."); };
export const deleteProductsByVendor = () => { throw new Error("Server-only: deleteProductsByVendor is not available on client."); };
export const deleteServicesByVendor = () => { throw new Error("Server-only: deleteServicesByVendor is not available on client."); };
export const deleteOrdersByVendor = () => { throw new Error("Server-only: deleteOrdersByVendor is not available on client."); };
export const deleteBookingsByVendor = () => { throw new Error("Server-only: deleteBookingsByVendor is not available on client."); };
export const deleteUserCartItemsByVendor = () => { throw new Error("Server-only: deleteUserCartItemsByVendor is not available on client."); };
export const deleteConversationsByVendor = () => { throw new Error("Server-only: deleteConversationsByVendor is not available on client."); };
export const deleteUser = () => { throw new Error("Server-only: deleteUser is not available on client."); };
export const deleteSessions = () => { throw new Error("Server-only: deleteSessions is not available on client."); };
// Stub exports for mongodb-operations (do not use on client)
export const getProducts = () => { throw new Error("Server-only: getProducts is not available on client."); };
export const createProduct = () => { throw new Error("Server-only: createProduct is not available on client."); };
export const updateProduct = () => { throw new Error("Server-only: updateProduct is not available on client."); };
export const deleteProduct = () => { throw new Error("Server-only: deleteProduct is not available on client."); };
export const getVendors = () => { throw new Error("Server-only: getVendors is not available on client."); };
export const getOrders = () => { throw new Error("Server-only: getOrders is not available on client."); };
export const getUserCart = () => { throw new Error("Server-only: getUserCart is not available on client."); };
export const updateUserProfileInDb = () => { throw new Error("Server-only: updateUserProfileInDb is not available on client."); };
export const deleteStore = () => { throw new Error("Server-only: deleteStore is not available on client."); };
export const deleteProductsByVendor = () => { throw new Error("Server-only: deleteProductsByVendor is not available on client."); };
export const deleteServicesByVendor = () => { throw new Error("Server-only: deleteServicesByVendor is not available on client."); };
export const deleteOrdersByVendor = () => { throw new Error("Server-only: deleteOrdersByVendor is not available on client."); };
export const deleteBookingsByVendor = () => { throw new Error("Server-only: deleteBookingsByVendor is not available on client."); };
export const deleteUserCartItemsByVendor = () => { throw new Error("Server-only: deleteUserCartItemsByVendor is not available on client."); };
export const deleteConversationsByVendor = () => { throw new Error("Server-only: deleteConversationsByVendor is not available on client."); };
export const deleteUser = () => { throw new Error("Server-only: deleteUser is not available on client."); };
export const deleteSessions = () => { throw new Error("Server-only: deleteSessions is not available on client."); };

export const getProducts = notServerError;
export const createChatMessage = notServerError;
export const getChatMessages = notServerError;
export const getConversations = notServerError;
export const createConversation = notServerError;
  await connectToDatabase()
  
  const query: any = {}
  
  if (filters?.category) {
    query.category = filters.category
  }
  if (filters?.vendorId) {
    query.vendorId = filters.vendorId
  }
  if (filters?.featured !== undefined) {
    query.featured = filters.featured
  }

  let productQuery = Product.find(query).sort({ createdAt: -1 })
  
  if (filters?.limitCount) {
    productQuery = productQuery.limit(filters.limitCount)
  }

  return await productQuery.lean().exec()
}

export const createProduct = async (productData: Omit<IProduct, 'id' | 'createdAt' | 'updatedAt'>) => {
  await connectToDatabase()
  
  const product = new Product({
    ...productData,
    status: productData.stock > 0 ? "active" : "out_of_stock"
  })
  
  const savedProduct = await product.save()
  return savedProduct._id.toString()
}

export const updateProduct = async (productId: string, productData: Partial<IProduct>) => {
  await connectToDatabase()
  
  await Product.findByIdAndUpdate(productId, productData, { new: true })
}

export const deleteProduct = async (productId: string) => {
  await connectToDatabase()
  
  await Product.findByIdAndDelete(productId)
}

export const getVendorProducts = async (vendorId: string) => {
  await connectToDatabase()
  
  return await Product.find({ vendorId })
    .sort({ createdAt: -1 })
    .lean()
    .exec()
}

export const getProductById = async (id: string) => {
  await connectToDatabase()
  
  const product = await Product.findById(id).lean().exec()
  if (!product) {
    throw new Error("Product not found")
  }
  return product
}

// Order operations
export const getOrders = async (filters?: {
  vendorId?: string
  customerId?: string
  status?: string
  limitCount?: number
}) => {
  await connectToDatabase()
  
  const query: any = {}
  
  if (filters?.vendorId) {
    query.vendorId = filters.vendorId
  }
  if (filters?.customerId) {
    query.customerId = filters.customerId
  }
  if (filters?.status) {
    query.status = filters.status
  }

  let orderQuery = Order.find(query).sort({ createdAt: -1 })
  
  if (filters?.limitCount) {
    orderQuery = orderQuery.limit(filters.limitCount)
  }

  return await orderQuery.lean().exec()
}

export const createOrder = async (orderData: Omit<IOrder, 'id' | 'createdAt' | 'updatedAt'>) => {
  await connectToDatabase()

  // Increment sales count for each product in the order
  if (orderData.items && Array.isArray(orderData.items)) {
    for (const item of orderData.items) {
      if (item.productId && item.quantity) {
        await Product.findByIdAndUpdate(
          item.productId,
          { $inc: { sales: item.quantity } },
          { new: true }
        )
      }
    }
// Stub exports for mongodb-operations (do not use on client)
export const getProducts = () => { throw new Error("Server-only: getProducts is not available on client."); };
export const createProduct = () => { throw new Error("Server-only: createProduct is not available on client."); };
export const updateProduct = () => { throw new Error("Server-only: updateProduct is not available on client."); };
export const deleteProduct = () => { throw new Error("Server-only: deleteProduct is not available on client."); };
export const getVendors = () => { throw new Error("Server-only: getVendors is not available on client."); };
export const getOrders = () => { throw new Error("Server-only: getOrders is not available on client."); };
export const getUserCart = () => { throw new Error("Server-only: getUserCart is not available on client."); };
export const updateUserProfileInDb = () => { throw new Error("Server-only: updateUserProfileInDb is not available on client."); };
export const deleteStore = () => { throw new Error("Server-only: deleteStore is not available on client."); };
export const deleteProductsByVendor = () => { throw new Error("Server-only: deleteProductsByVendor is not available on client."); };
export const deleteServicesByVendor = () => { throw new Error("Server-only: deleteServicesByVendor is not available on client."); };
export const deleteOrdersByVendor = () => { throw new Error("Server-only: deleteOrdersByVendor is not available on client."); };
export const deleteBookingsByVendor = () => { throw new Error("Server-only: deleteBookingsByVendor is not available on client."); };
export const deleteUserCartItemsByVendor = () => { throw new Error("Server-only: deleteUserCartItemsByVendor is not available on client."); };
export const deleteConversationsByVendor = () => { throw new Error("Server-only: deleteConversationsByVendor is not available on client."); };
export const deleteUser = () => { throw new Error("Server-only: deleteUser is not available on client."); };
export const deleteSessions = () => { throw new Error("Server-only: deleteSessions is not available on client."); };